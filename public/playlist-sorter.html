<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Sorter</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="icon/png" href="icons/shortcut-icon.ico">
    <!-- PWA Metadata -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1DB954">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spotify Sorter">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png">
</head>
<body>
    <div class="container">
        <h1>Trieur de Playlists Spotify</h1>
        
        <div id="playlist-selection">
            <h2>1. Choisissez une playlist source</h2>
            
            <div class="source-selection">
                <div class="tab-container">
                    <button class="tab-button active" onclick="showTab('user-playlists-tab')">Mes playlists</button>
                    <button class="tab-button" onclick="showTab('external-playlist-tab')">Playlist externe</button>
                </div>
                
                <div id="user-playlists-tab" class="tab-content active">
                    <div class="loading">Chargement de vos playlists...</div>
                    <div id="user-playlists-container" class="playlists-grid"></div>
                </div>
                
                <div id="external-playlist-tab" class="tab-content">
                    <form id="external-playlist-form">
                        <label for="playlist-url">URL de la playlist Spotify:</label>
                        <input type="text" id="playlist-url" placeholder="https://open.spotify.com/playlist/..." required>
                        <button type="submit" class="button">Utiliser cette playlist</button>
                    </form>
                </div>
            </div>
            
            <div id="selected-source" style="display: none;">
                <h3>Playlist source sélectionnée:</h3>
                <div id="source-playlist-info" class="selected-playlist-info"></div>
                <button onclick="resetSourceSelection()" class="button secondary">Changer</button>
            </div>
        </div>
        
        <div id="target-selection" style="display: none;">
            <h2>2. Sélectionnez les playlists cibles</h2>
            <p>Choisissez les playlists dans lesquelles vous souhaitez répartir les morceaux:</p>
            
            <div class="loading">Chargement de vos playlists...</div>
            <div id="target-playlists-container" class="playlists-grid"></div>
            
            <div id="selected-targets" style="display: none;">
                <h3>Playlists cibles sélectionnées:</h3>
                <div id="target-playlists-info" class="selected-playlists-info"></div>
            </div>
            
            <div class="action-buttons">
                <button id="start-sorting-button" class="button" disabled>Commencer le tri</button>
                <button onclick="resetTargetSelection()" class="button secondary">Réinitialiser la sélection</button>
            </div>
        </div>
        
        <div id="sorting-interface" style="display: none;">
            <h2>3. Tri des morceaux</h2>
            
            <div class="progress-container">
                <div class="progress-info">
                    <span id="current-track-number">1</span>/<span id="total-tracks">0</span> morceaux traités
                </div>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>
            
            <div class="history-toggle">
                <button id="show-history-button" class="button secondary" onclick="toggleHistory()">
                    <span id="history-button-text">Afficher l'historique</span>
                    <span id="history-count" class="history-count">0</span>
                </button>
            </div>
            
            <div id="history-panel" class="history-panel" style="display: none;">
                <h3>Historique des ajouts</h3>
                <div class="history-container">
                    <div id="history-items" class="history-items">
                        <!-- Les éléments d'historique seront ajoutés ici -->
                        <div class="history-empty">Aucun historique pour le moment</div>
                    </div>
                </div>
            </div>
            
            <div id="current-track-container" class="current-track">
                <div class="track-info">
                    <img id="track-image" src="default-album.png" alt="Album" class="track-img">
                    <div class="track-details">
                        <h3 id="track-title">Titre de la chanson</h3>
                        <p id="track-artist">Artiste</p>
                        <p id="track-album">Album</p>
                    </div>
                </div>
                
                <div class="player-container">
                    <audio id="audio-player" controls></audio>
                </div>
                
                <div class="sorting-question">
                    <p>Dans quelle(s) playlist(s) souhaitez-vous ajouter ce morceau ?</p>
                    <p class="playlist-selection-info">Vous pouvez sélectionner plusieurs playlists avant de passer à la chanson suivante.</p>
                </div>
                
                <div id="target-buttons" class="target-buttons">
                    <!-- Les boutons de playlist cible seront générés ici -->
                </div>
                
                <div class="navigation-buttons">
                    <button id="skip-button" class="button secondary">Ignorer ce morceau</button>
                    <button id="previous-button" class="button secondary" disabled>Précédent</button>
                    <button id="next-track-button" class="button primary">Morceau suivant</button>
                </div>
            </div>
        </div>
        
        <div id="sorting-results" style="display: none;">
            <h2>4. Résultats du tri</h2>
            <div id="results-container" class="sorting-summary"></div>
            <button onclick="backToStart()" class="button">Recommencer</button>
        </div>
    </div>

    <script>
        let userPlaylists = [];
        let selectedSourcePlaylist = null;
        let selectedTargetPlaylists = [];
        let playlistTracks = [];
        let currentTrackIndex = 0;
        let sortingResults = {
            totalTracks: 0,
            processedTracks: 0,
            targetPlaylists: []
        };
        
        // Variables pour le suivi des playlists auxquelles le morceau actuel a été ajouté
        let currentTrackAddedTo = [];
        
        // Variables pour l'historique
        let addHistory = [];
        
        // Vérifier l'authentification au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) {
                window.location.href = '/login';
                return;
            }
            
            // Charger les playlists de l'utilisateur
            loadUserPlaylists();
            
            // Gérer le formulaire de playlist externe
            document.getElementById('external-playlist-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const playlistUrl = document.getElementById('playlist-url').value;
                loadExternalPlaylist(playlistUrl);
            });
            
            // Configurer les boutons de navigation
            document.getElementById('skip-button').addEventListener('click', skipTrack);
            document.getElementById('previous-button').addEventListener('click', previousTrack);
            document.getElementById('next-track-button').addEventListener('click', nextTrack);
        });
        
        // Fonction pour vérifier si les tokens sont valides
        function checkAuth() {
            const accessToken = localStorage.getItem('spotify_access_token');
            const expirationTime = localStorage.getItem('spotify_token_expiration');
            
            if (!accessToken || !expirationTime) {
                return false;
            }
            
            // Vérifier si le token a expiré
            if (Date.now() > parseInt(expirationTime)) {
                // Token expiré, nettoyer le localStorage et rediriger vers login
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_refresh_token');
                localStorage.removeItem('spotify_token_expiration');
                localStorage.removeItem('spotify_user_profile');
                return false;
            }
            
            return true;
        }
        
        // Fonction pour obtenir l'access token du localStorage
        function getAccessToken() {
            return localStorage.getItem('spotify_access_token');
        }
        
        // Fonction pour obtenir l'ID utilisateur du localStorage
        function getUserId() {
            const profile = JSON.parse(localStorage.getItem('spotify_user_profile'));
            return profile ? profile.id : null;
        }
        
        // Fonction pour afficher un onglet
        function showTab(tabId) {
            // Cacher tous les contenus d'onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Désactiver tous les boutons d'onglets
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Afficher l'onglet sélectionné
            document.getElementById(tabId).classList.add('active');
            
            // Activer le bouton d'onglet correspondant
            event.target.classList.add('active');
        }
        
        // Fonction pour charger les playlists de l'utilisateur
        function loadUserPlaylists() {
            const accessToken = getAccessToken();
            
            fetch('/api/user-data', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            // Si token expiré, rediriger vers login
                            localStorage.clear();
                            window.location.href = '/login';
                            return null;
                        }
                        throw new Error(`API responded with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    
                    if (!data.playlists || !data.playlists.items) {
                        throw new Error('No playlist data available');
                    }
                    
                    // Mettre à jour le profil dans le localStorage
                    if (data.profile) {
                        localStorage.setItem('spotify_user_profile', JSON.stringify(data.profile));
                    }
                    
                    userPlaylists = data.playlists.items;
                    renderUserPlaylists();
                })
                .catch(error => {
                    console.error('Error loading user playlists:', error);
                    document.querySelector('#user-playlists-tab .loading').innerHTML = 
                        `Erreur lors du chargement des playlists: ${error.message}`;
                });
        }
        
        // Fonction pour afficher les playlists de l'utilisateur
        function renderUserPlaylists() {
            const container = document.getElementById('user-playlists-container');
            document.querySelector('#user-playlists-tab .loading').style.display = 'none';
            
            if (userPlaylists.length === 0) {
                container.innerHTML = '<p>Aucune playlist trouvée.</p>';
                return;
            }
            
            let html = '';
            userPlaylists.forEach(playlist => {
                const playlistImg = playlist.images && playlist.images.length > 0 ?
                    playlist.images[0].url : 'default-playlist.png';
                
                html += `
                    <div class="playlist-card" onclick="selectSourcePlaylist('${playlist.id}')">
                        <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img">
                        <h3>${playlist.name}</h3>
                        <p>${playlist.tracks.total} morceaux</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Fonction pour sélectionner une playlist source
        function selectSourcePlaylist(playlistId) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist) return;
            
            selectedSourcePlaylist = playlist;
            
            // Afficher les informations de la playlist sélectionnée
            const playlistImg = playlist.images && playlist.images.length > 0 ?
                playlist.images[0].url : 'default-playlist.png';
            
            document.getElementById('source-playlist-info').innerHTML = `
                <div class="selected-playlist">
                    <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img">
                    <div class="playlist-details">
                        <h4>${playlist.name}</h4>
                        <p>${playlist.tracks.total} morceaux</p>
                    </div>
                </div>
            `;
            
            // Cacher la sélection et afficher la playlist choisie
            document.querySelector('.source-selection').style.display = 'none';
            document.getElementById('selected-source').style.display = 'block';
            
            // Passer à l'étape suivante
            document.getElementById('target-selection').style.display = 'block';
            
            // Charger les playlists cibles (exclure la source)
            loadTargetPlaylists();
        }
        
        // Fonction pour charger une playlist externe
        function loadExternalPlaylist(url) {
            // Extraire l'ID de la playlist à partir de l'URL
            const playlistId = extractPlaylistId(url);
            if (!playlistId) {
                alert('URL de playlist non valide. Veuillez vérifier le format.');
                return;
            }
            
            // Afficher un indicateur de chargement
            document.getElementById('external-playlist-tab').innerHTML = 
                '<div class="loading">Chargement de la playlist...</div>';
            
            const accessToken = getAccessToken();
            
            // Faire une requête à l'API pour obtenir les informations de la playlist
            fetch(`/api/playlist/${playlistId}`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API responded with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(playlist => {
                    selectedSourcePlaylist = playlist;
                    
                    // Afficher les informations de la playlist
                    const playlistImg = playlist.images && playlist.images.length > 0 ?
                        playlist.images[0].url : 'default-playlist.png';
                    
                    document.getElementById('source-playlist-info').innerHTML = `
                        <div class="selected-playlist">
                            <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img">
                            <div class="playlist-details">
                                <h4>${playlist.name}</h4>
                                <p>${playlist.tracks.total} morceaux</p>
                            </div>
                        </div>
                    `;
                    
                    // Cacher la sélection et afficher la playlist choisie
                    document.querySelector('.source-selection').style.display = 'none';
                    document.getElementById('selected-source').style.display = 'block';
                    
                    // Passer à l'étape suivante
                    document.getElementById('target-selection').style.display = 'block';
                    
                    // Charger les playlists cibles
                    loadTargetPlaylists();
                })
                .catch(error => {
                    console.error('Error loading external playlist:', error);
                    document.getElementById('external-playlist-tab').innerHTML = 
                        `<p class="error">Erreur: ${error.message}</p>
                         <button onclick="showTab('external-playlist-tab')" class="button">Réessayer</button>`;
                });
        }
        
        // Fonction pour extraire l'ID de la playlist à partir d'une URL
        function extractPlaylistId(url) {
            // Format attendu: https://open.spotify.com/playlist/37i9dQZF1DX4sWSpwq3LiO
            const regex = /playlist\/([a-zA-Z0-9]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }
        
        // Fonction pour charger les playlists cibles
        function loadTargetPlaylists() {
            const container = document.getElementById('target-playlists-container');
            const loadingEl = document.querySelector('#target-selection .loading');
            
            if (userPlaylists.length === 0) {
                loadUserPlaylists().then(() => {
                    renderTargetPlaylists();
                });
            } else {
                loadingEl.style.display = 'none';
                renderTargetPlaylists();
            }
        }
        
        // Fonction pour afficher les playlists cibles
        function renderTargetPlaylists() {
            const container = document.getElementById('target-playlists-container');
            document.querySelector('#target-selection .loading').style.display = 'none';
            
            // Filtrer pour ne pas inclure la playlist source
            const availablePlaylists = userPlaylists.filter(p => 
                !selectedSourcePlaylist || p.id !== selectedSourcePlaylist.id);
            
            if (availablePlaylists.length === 0) {
                container.innerHTML = '<p>Aucune autre playlist disponible.</p>';
                return;
            }
            
            let html = '';
            const loadingPromises = [];
            
            // Vérifier pour chaque playlist si elle est modifiable
            availablePlaylists.forEach(playlist => {
                const playlistImg = playlist.images && playlist.images.length > 0 ?
                    playlist.images[0].url : 'default-playlist.png';
                
                const isSelected = selectedTargetPlaylists.some(p => p.id === playlist.id);
                const selectedClass = isSelected ? 'selected' : '';
                
                // Si la permission a déjà été vérifiée
                if (playlist.hasOwnProperty('canModify')) {
                    const disabledClass = !playlist.canModify ? 'disabled' : '';
                    const ownerInfo = !playlist.canModify ? 
                        `<div class="owner-info">Propriétaire: ${playlist.owner}</div>` : '';
                    const modifiableIcon = playlist.canModify ? 
                        `<div class="modifiable-indicator" title="${playlist.isOwner ? 'Vous êtes propriétaire' : 'Playlist collaborative'}">✓</div>` : 
                        `<div class="non-modifiable-indicator" title="Vous ne pouvez pas modifier cette playlist">❌</div>`;
                    
                    html += `
                        <div class="playlist-card ${selectedClass} ${disabledClass}" 
                             onclick="${playlist.canModify ? `toggleTargetPlaylist('${playlist.id}')` : ''}"
                             ${!playlist.canModify ? 'title="Vous ne pouvez pas modifier cette playlist"' : ''}>
                            <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img">
                            <h3>${playlist.name}</h3>
                            <p>${playlist.tracks.total} morceaux</p>
                            ${modifiableIcon}
                            ${ownerInfo}
                            ${isSelected ? '<div class="selection-indicator">✓</div>' : ''}
                        </div>
                    `;
                } else {
                    // Si la permission n'a pas encore été vérifiée, on affiche un indicateur de chargement
                    const playlistCard = `
                        <div class="playlist-card loading-permission" id="playlist-card-${playlist.id}">
                            <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img">
                            <h3>${playlist.name}</h3>
                            <p>${playlist.tracks.total} morceaux</p>
                            <div class="permission-loading">⟳</div>
                        </div>
                    `;
                    html += playlistCard;
                    
                    // Ajouter la requête de vérification à notre liste
                    const accessToken = getAccessToken();
                    const userId = getUserId();
                    
                    const loadingPromise = fetch(`/api/playlist/${playlist.id}/check-permissions?userId=${userId}`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`API responded with status ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Stocker les informations de permission dans l'objet playlist
                            playlist.canModify = data.canModify;
                            playlist.isOwner = data.isOwner;
                            playlist.isCollaborative = data.isCollaborative;
                            playlist.owner = data.playlist && data.playlist.owner ? data.playlist.owner : 'Inconnu';
                            
                            // Mettre à jour le DOM pour cette playlist
                            const card = document.getElementById(`playlist-card-${playlist.id}`);
                            if (card) {
                                const disabledClass = !data.canModify ? 'disabled' : '';
                                const ownerInfo = !data.canModify ? 
                                    `<div class="owner-info">Propriétaire: ${data.playlist && data.playlist.owner ? data.playlist.owner : 'Inconnu'}</div>` : '';
                                const modifiableIcon = data.canModify ? 
                                    `<div class="modifiable-indicator" title="${data.isOwner ? 'Vous êtes propriétaire' : 'Playlist collaborative'}">✓</div>` : 
                                    `<div class="non-modifiable-indicator" title="Vous ne pouvez pas modifier cette playlist">❌</div>`;
                                
                                const newCard = `
                                    <div class="playlist-card ${disabledClass}" 
                                         onclick="${data.canModify ? `toggleTargetPlaylist('${playlist.id}')` : ''}"
                                         ${!data.canModify ? 'title="Vous ne pouvez pas modifier cette playlist"' : ''}>
                                        <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img">
                                        <h3>${playlist.name}</h3>
                                        <p>${playlist.tracks.total} morceaux</p>
                                        ${modifiableIcon}
                                        ${ownerInfo}
                                    </div>
                                `;
                                
                                card.outerHTML = newCard;
                            }
                        })
                        .catch(error => {
                            console.error(`Error checking permissions for playlist ${playlist.id}:`, error);
                            // En cas d'erreur, on considère que la playlist n'est pas modifiable
                            playlist.canModify = false;
                            playlist.owner = 'Inconnu (erreur)';
                            
                            const card = document.getElementById(`playlist-card-${playlist.id}`);
                            if (card) {
                                card.classList.add('disabled');
                                card.innerHTML = `
                                    <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img">
                                    <h3>${playlist.name}</h3>
                                    <p>${playlist.tracks.total} morceaux</p>
                                    <div class="non-modifiable-indicator" title="Erreur lors de la vérification des permissions">❌</div>
                                    <div class="owner-info">Erreur: Impossible de vérifier les permissions</div>
                                `;
                            }
                        });
                    
                    loadingPromises.push(loadingPromise);
                }
            });
            
            container.innerHTML = html;
            
            // Si toutes les permissions sont déjà vérifiées, pas besoin d'attendre
            if (loadingPromises.length === 0) {
                updateStartButton();
            } else {
                // Sinon, attendre que toutes les requêtes de vérification soient terminées
                Promise.all(loadingPromises).then(() => {
                    updateStartButton();
                });
            }
        }

        // Fonction pour sélectionner/désélectionner une playlist cible
        function toggleTargetPlaylist(playlistId) {
            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist) return;
            
            // Vérifier si la playlist est modifiable
            if (playlist.hasOwnProperty('canModify') && !playlist.canModify) {
                alert('Vous ne pouvez pas utiliser cette playlist comme cible car vous n\'en êtes pas le propriétaire et elle n\'est pas collaborative.');
                return;
            }
            
            const index = selectedTargetPlaylists.findIndex(p => p.id === playlistId);
            
            if (index === -1) {
                // Ajouter à la sélection
                selectedTargetPlaylists.push(playlist);
            } else {
                // Retirer de la sélection
                selectedTargetPlaylists.splice(index, 1);
            }
            
            // Mettre à jour l'affichage
            renderTargetPlaylists();
            updateSelectedTargets();
        }
        
        // Mettre à jour l'affichage des playlists cibles sélectionnées
        function updateSelectedTargets() {
            const container = document.getElementById('target-playlists-info');
            const selectedTargetsEl = document.getElementById('selected-targets');
            
            if (selectedTargetPlaylists.length === 0) {
                selectedTargetsEl.style.display = 'none';
                return;
            }
            
            selectedTargetsEl.style.display = 'block';
            
            let html = '';
            selectedTargetPlaylists.forEach(playlist => {
                const playlistImg = playlist.images && playlist.images.length > 0 ?
                    playlist.images[0].url : 'default-playlist.png';
                
                html += `
                    <div class="selected-playlist">
                        <img src="${playlistImg}" alt="${playlist.name}" class="playlist-img-small">
                        <div class="playlist-details">
                            <h4>${playlist.name}</h4>
                            <p>${playlist.tracks.total} morceaux</p>
                        </div>
                        <button onclick="removeTargetPlaylist('${playlist.id}')" class="remove-button">×</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateStartButton();
        }
        
        // Fonction pour retirer une playlist cible de la sélection
        function removeTargetPlaylist(playlistId) {
            const index = selectedTargetPlaylists.findIndex(p => p.id === playlistId);
            if (index !== -1) {
                selectedTargetPlaylists.splice(index, 1);
                renderTargetPlaylists();
                updateSelectedTargets();
            }
        }
        
        // Mettre à jour l'état du bouton de démarrage
        function updateStartButton() {
            const button = document.getElementById('start-sorting-button');
            button.disabled = selectedTargetPlaylists.length === 0;
            
            if (selectedTargetPlaylists.length > 0) {
                button.onclick = startSorting;
            } else {
                button.onclick = null;
            }
        }
        
        // Fonction pour réinitialiser la sélection de la source
        function resetSourceSelection() {
            selectedSourcePlaylist = null;
            document.querySelector('.source-selection').style.display = 'block';
            document.getElementById('selected-source').style.display = 'none';
            document.getElementById('target-selection').style.display = 'none';
            
            // Réinitialiser l'onglet de playlist externe
            document.getElementById('external-playlist-tab').innerHTML = `
                <form id="external-playlist-form">
                    <label for="playlist-url">URL de la playlist Spotify:</label>
                    <input type="text" id="playlist-url" placeholder="https://open.spotify.com/playlist/..." required>
                    <button type="submit" class="button">Utiliser cette playlist</button>
                </form>
            `;
            
            // Réattacher l'event listener
            document.getElementById('external-playlist-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const playlistUrl = document.getElementById('playlist-url').value;
                loadExternalPlaylist(playlistUrl);
            });
        }
        
        // Fonction pour réinitialiser la sélection des cibles
        function resetTargetSelection() {
            selectedTargetPlaylists = [];
            renderTargetPlaylists();
            updateSelectedTargets();
        }
        
        // Fonction pour démarrer le tri
        function startSorting() {
            if (!selectedSourcePlaylist || selectedTargetPlaylists.length === 0) {
                alert('Veuillez sélectionner une playlist source et au moins une playlist cible.');
                return;
            }
            
            // Cacher les sections précédentes
            document.getElementById('target-selection').style.display = 'none';
            document.getElementById('playlist-selection').style.display = 'none';
            
            // Afficher l'interface de tri et indiquer le chargement
            const sortingInterface = document.getElementById('sorting-interface');
            sortingInterface.style.display = 'block';
            
            // Ajouter un overlay de chargement plutôt que de remplacer tout le contenu
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loading-overlay';
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = '<div class="loading">Chargement des morceaux de la playlist source...</div>';
            sortingInterface.appendChild(loadingOverlay);
            
            // Initialiser les résultats du tri
            sortingResults = {
                totalTracks: 0,
                processedTracks: 0,
                targetPlaylists: selectedTargetPlaylists.map(p => ({
                    id: p.id,
                    name: p.name,
                    addedTracks: 0
                }))
            };
            
            // Réinitialiser l'historique
            addHistory = [];
            updateHistory();
            
            const accessToken = getAccessToken();
            
            // Charger les pistes de la playlist source
            fetch(`/api/playlist/${selectedSourcePlaylist.id}/tracks`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API responded with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.items || data.items.length === 0) {
                        throw new Error('No tracks found in the source playlist');
                    }
                    
                    // Stocker les pistes
                    playlistTracks = data.items.map(item => item.track).filter(track => track !== null);
                    sortingResults.totalTracks = playlistTracks.length;
                    currentTrackIndex = 0;
                    
                    // Retirer l'overlay de chargement
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.remove();
                    }
                    
                    // Mettre à jour l'interface de tri
                    updateSortingInterface();
                })
                .catch(error => {
                    console.error('Error loading playlist tracks:', error);
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.innerHTML = 
                            `<p class="error">Erreur lors du chargement des morceaux: ${error.message}</p>
                             <button onclick="backToStart()" class="button">Retour</button>`;
                    }
                });
        }
        
        // Fonction pour mettre à jour l'interface de tri
        function updateSortingInterface() {
            // Vérifier si nous avons atteint la fin de la liste des pistes
            if (currentTrackIndex >= playlistTracks.length) {
                // Tous les morceaux ont été traités
                showResults();
                return;
            }
            
            // Réinitialiser la liste des playlists auxquelles le morceau actuel a été ajouté
            currentTrackAddedTo = [];
            
            const track = playlistTracks[currentTrackIndex];
            
            // Vérifier que les éléments DOM existent avant de les mettre à jour
            const currentTrackNumberEl = document.getElementById('current-track-number');
            const totalTracksEl = document.getElementById('total-tracks');
            const progressFillEl = document.getElementById('progress-fill');
            const trackTitleEl = document.getElementById('track-title');
            const trackArtistEl = document.getElementById('track-artist');
            const trackAlbumEl = document.getElementById('track-album');
            const trackImageEl = document.getElementById('track-image');
            const audioPlayerEl = document.getElementById('audio-player');
            const targetButtonsEl = document.getElementById('target-buttons');
            const previousButtonEl = document.getElementById('previous-button');
            const nextTrackButtonEl = document.getElementById('next-track-button');
            
            // Vérifier que tous les éléments existent
            if (!currentTrackNumberEl || !totalTracksEl || !progressFillEl || !trackTitleEl || 
                !trackArtistEl || !trackAlbumEl || !trackImageEl || !audioPlayerEl || 
                !targetButtonsEl || !previousButtonEl || !nextTrackButtonEl) {
                console.error('Certains éléments DOM requis sont manquants');
                return;
            }
            
            // Mettre à jour les informations de progression
            currentTrackNumberEl.textContent = currentTrackIndex + 1;
            totalTracksEl.textContent = playlistTracks.length;
            
            // Mettre à jour la barre de progression
            const progressPercentage = ((currentTrackIndex) / playlistTracks.length) * 100;
            progressFillEl.style.width = `${progressPercentage}%`;
            
            // Mettre à jour les informations de la piste
            trackTitleEl.textContent = track.name;
            trackArtistEl.textContent = track.artists.map(artist => artist.name).join(', ');
            trackAlbumEl.textContent = track.album.name;
            
            // Mettre à jour l'image de l'album
            const albumImg = track.album.images && track.album.images.length > 0 ?
                track.album.images[0].url : 'default-album.png';
            trackImageEl.src = albumImg;
            
            // Mettre à jour le lecteur audio
            const playerContainer = document.querySelector('.player-container');
            // Nettoyer les messages d'erreur précédents
            const errorMessages = playerContainer.querySelectorAll('.error');
            errorMessages.forEach(el => el.remove());
            
            if (track.preview_url) {
                audioPlayerEl.src = track.preview_url;
                audioPlayerEl.disabled = false;
                try {
                    audioPlayerEl.play().catch(e => {
                        console.warn('Autoplay prevented by browser', e);
                    });
                } catch (e) {
                    console.warn('Error playing audio', e);
                }
            } else {
                audioPlayerEl.src = '';
                audioPlayerEl.disabled = true;
                playerContainer.insertAdjacentHTML('beforeend', 
                    '<p class="error">Aperçu audio non disponible pour ce morceau.</p>');
            }
            
            // Mettre à jour les boutons de playlist cible
            updateTargetButtons();
            
            // Mettre à jour l'état du bouton précédent
            previousButtonEl.disabled = currentTrackIndex === 0;
            
            // Activer le bouton suivant
            nextTrackButtonEl.disabled = false;
        }
        
        // Fonction pour mettre à jour les boutons de playlist cible
        function updateTargetButtons() {
            const targetButtonsEl = document.getElementById('target-buttons');
            if (!targetButtonsEl) return;
            
            let buttonsHtml = '';
            
            selectedTargetPlaylists.forEach(playlist => {
                const playlistImg = playlist.images && playlist.images.length > 0 ?
                    playlist.images[0].url : 'default-playlist.png';
                
                // Vérifier si le morceau a déjà été ajouté à cette playlist
                const isAlreadyAdded = currentTrackAddedTo.includes(playlist.id);
                const addedClass = isAlreadyAdded ? 'added' : '';
                const addedText = isAlreadyAdded ? '<span class="added-text">✓ Ajouté</span>' : '';
                
                buttonsHtml += `
                    <button class="target-button ${addedClass}" onclick="addTrackToPlaylist('${playlist.id}')">
                        <img src="${playlistImg}" alt="${playlist.name}" class="playlist-icon">
                        <div class="playlist-button-text">
                            <span>${playlist.name}</span>
                            ${addedText}
                        </div>
                    </button>
                `;
            });
            
            targetButtonsEl.innerHTML = buttonsHtml;
        }
        
        // Fonction pour ajouter une piste à une playlist cible
        function addTrackToPlaylist(playlistId) {
            if (currentTrackIndex >= playlistTracks.length) return;
            
            // Si le morceau a déjà été ajouté à cette playlist, ne rien faire
            if (currentTrackAddedTo.includes(playlistId)) {
                return;
            }
            
            const track = playlistTracks[currentTrackIndex];
            const trackUri = `spotify:track:${track.id}`;
            
            // Trouver la playlist dans la liste des playlists cibles
            const playlist = selectedTargetPlaylists.find(p => p.id === playlistId);
            if (!playlist) return;
            
            // Trouver le bouton de la playlist et le marquer comme en cours de chargement
            const targetButtons = document.querySelectorAll('.target-button');
            let targetButton = null;
            
            targetButtons.forEach(button => {
                if (button.getAttribute('onclick') === `addTrackToPlaylist('${playlistId}')`) {
                    targetButton = button;
                }
            });
            
            if (targetButton) {
                targetButton.classList.add('loading');
                targetButton.innerHTML = '<div class="button-loading">Ajout en cours...</div>';
            }
            
            const accessToken = getAccessToken();
            const userId = getUserId();
            
            // Envoyer la requête à l'API
            fetch(`/api/playlist/${playlistId}/add-track`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ trackUri, userId })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Ajouter cette playlist à la liste des playlists auxquelles le morceau a été ajouté
                currentTrackAddedTo.push(playlistId);
                
                // Mettre à jour les résultats
                const targetPlaylist = sortingResults.targetPlaylists.find(p => p.id === playlistId);
                if (targetPlaylist) {
                    targetPlaylist.addedTracks++;
                }
                
                // Ajouter à l'historique
                addToHistory(track, playlist);
                
                // Mettre à jour les boutons
                updateTargetButtons();
            })
            .catch(error => {
                console.error('Error adding track to playlist:', error);
                
                // Restaurer le bouton en cas d'erreur
                if (targetButton) {
                    targetButton.classList.remove('loading');
                    targetButton.innerHTML = `
                        <img src="${targetButton.querySelector('img').src}" alt="${targetButton.querySelector('img').alt}" class="playlist-icon">
                        <div class="playlist-button-text">
                            <span>${targetButton.querySelector('img').alt}</span>
                            <span class="error-text">Erreur: ${error.message}</span>
                        </div>
                    `;
                }
            });
        }
        
        // Fonction pour passer au morceau suivant après avoir ajouté à des playlists
        function nextTrack() {
            // Si le morceau actuel a été ajouté à au moins une playlist, compter comme traité
            if (currentTrackAddedTo.length > 0) {
                sortingResults.processedTracks++;
            }
            
            // Passer au morceau suivant
            currentTrackIndex++;
            updateSortingInterface();
        }
        
        // Fonction pour ignorer une piste
        function skipTrack() {
            if (currentTrackIndex >= playlistTracks.length) return;
            
            sortingResults.processedTracks++;
            currentTrackIndex++;
            updateSortingInterface();
        }
        
        // Fonction pour revenir à la piste précédente
        function previousTrack() {
            if (currentTrackIndex <= 0) return;
            
            // Si le morceau actuel a été traité, décrémenter le compteur
            if (currentTrackAddedTo.length > 0) {
                sortingResults.processedTracks--;
            }
            
            currentTrackIndex--;
            updateSortingInterface();
        }
        
        // Fonction pour afficher les résultats du tri
        function showResults() {
            document.getElementById('sorting-interface').style.display = 'none';
            
            const resultsContainer = document.getElementById('results-container');
            let html = '<div class="sorting-summary">';
            
            html += `<p>Le tri a été effectué avec succès !</p>`;
            html += `<p>${sortingResults.processedTracks} morceaux sur ${sortingResults.totalTracks} de la playlist "${selectedSourcePlaylist.name}" ont été traités.</p>`;
            
            html += '<h3>Détails par playlist:</h3><ul>';
            sortingResults.targetPlaylists.forEach(playlist => {
                html += `<li><strong>${playlist.name}</strong>: ${playlist.addedTracks} morceaux ajoutés</li>`;
            });
            html += '</ul></div>';
            
            resultsContainer.innerHTML = html;
            document.getElementById('sorting-results').style.display = 'block';
        }
        
        // Fonction pour revenir au début
        function backToStart() {
            selectedSourcePlaylist = null;
            selectedTargetPlaylists = [];
            playlistTracks = [];
            currentTrackIndex = 0;
            
            document.getElementById('playlist-selection').style.display = 'block';
            document.getElementById('selected-source').style.display = 'none';
            document.querySelector('.source-selection').style.display = 'block';
            document.getElementById('target-selection').style.display = 'none';
            document.getElementById('sorting-interface').style.display = 'none';
            document.getElementById('sorting-results').style.display = 'none';
            
            // Réinitialiser l'onglet de playlist externe
            resetSourceSelection();
            
            // Réinitialiser l'historique
            addHistory = [];
        }
        
        // Fonction pour afficher/masquer l'historique
        function toggleHistory() {
            const historyPanel = document.getElementById('history-panel');
            const historyButtonText = document.getElementById('history-button-text');
            
            if (historyPanel.style.display === 'none') {
                historyPanel.style.display = 'block';
                historyButtonText.textContent = 'Masquer l\'historique';
            } else {
                historyPanel.style.display = 'none';
                historyButtonText.textContent = 'Afficher l\'historique';
            }
        }
        
        // Fonction pour mettre à jour l'historique
        function updateHistory() {
            const historyItems = document.getElementById('history-items');
            const historyCount = document.getElementById('history-count');
            
            if (!historyItems) return;
            
            // Mettre à jour le compteur
            historyCount.textContent = addHistory.length;
            
            if (addHistory.length === 0) {
                historyItems.innerHTML = '<div class="history-empty">Aucun historique pour le moment</div>';
                return;
            }
            
            let html = '';
            
            // Trier l'historique par date récente en premier
            const sortedHistory = [...addHistory].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedHistory.forEach((item, index) => {
                const trackName = item.track.name;
                const artistName = item.track.artists.map(a => a.name).join(', ');
                const playlistName = item.playlist.name;
                const playlistImg = item.playlist.images && item.playlist.images.length > 0 ?
                    item.playlist.images[0].url : 'default-playlist.png';
                const trackImg = item.track.album.images && item.track.album.images.length > 0 ?
                    item.track.album.images[0].url : 'default-album.png';
                
                html += `
                    <div class="history-item">
                        <div class="history-track-info">
                            <img src="${trackImg}" alt="${trackName}" class="history-track-img">
                            <div class="history-track-details">
                                <h4>${trackName}</h4>
                                <p>${artistName}</p>
                            </div>
                        </div>
                        <div class="history-playlist-info">
                            <img src="${playlistImg}" alt="${playlistName}" class="history-playlist-img">
                            <span>${playlistName}</span>
                        </div>
                        <button class="remove-history-button" onclick="removeTrackFromPlaylist(${index})">
                            <span>Retirer</span>
                        </button>
                    </div>
                `;
            });
            
            historyItems.innerHTML = html;
        }
        
        // Fonction pour ajouter un élément à l'historique
        function addToHistory(track, playlist) {
            addHistory.push({
                track: track,
                playlist: playlist,
                timestamp: Date.now()
            });
            
            updateHistory();
        }
        
        // Fonction pour retirer une piste d'une playlist depuis l'historique
        function removeTrackFromPlaylist(historyIndex) {
            if (historyIndex < 0 || historyIndex >= addHistory.length) return;
            
            const historyItem = addHistory[historyIndex];
            const track = historyItem.track;
            const playlist = historyItem.playlist;
            
            // Afficher un indicateur de chargement dans l'élément d'historique
            const historyItems = document.querySelectorAll('.history-item');
            if (historyItems[historyIndex]) {
                historyItems[historyIndex].classList.add('loading');
                historyItems[historyIndex].innerHTML = '<div class="loading">Suppression en cours...</div>';
            }
            
            const accessToken = getAccessToken();
            const userId = getUserId();
            
            // Envoyer la requête à l'API
            fetch(`/api/playlist/${playlist.id}/remove-track`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    trackUri: `spotify:track:${track.id}`,
                    userId: userId
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API responded with status ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Supprimer l'élément de l'historique
                addHistory.splice(historyIndex, 1);
                
                // Mettre à jour les résultats du tri
                const targetPlaylist = sortingResults.targetPlaylists.find(p => p.id === playlist.id);
                if (targetPlaylist && targetPlaylist.addedTracks > 0) {
                    targetPlaylist.addedTracks--;
                }
                
                // Mettre à jour l'historique
                updateHistory();
                
                // Si le morceau actuel est dans une playlist de laquelle il vient d'être retiré,
                // mettre à jour les boutons cibles
                if (currentTrackIndex < playlistTracks.length) {
                    const currentTrack = playlistTracks[currentTrackIndex];
                    if (currentTrack.id === track.id) {
                        const index = currentTrackAddedTo.indexOf(playlist.id);
                        if (index !== -1) {
                            currentTrackAddedTo.splice(index, 1);
                            updateTargetButtons();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error removing track from playlist:', error);
                
                // Restaurer l'élément d'historique en cas d'erreur et afficher l'erreur
                updateHistory();
                alert(`Erreur lors de la suppression: ${error.message}`);
            });
        }
        
        // Fonction de déconnexion
        function logout() {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_refresh_token');
            localStorage.removeItem('spotify_token_expiration');
            localStorage.removeItem('spotify_user_profile');
            window.location.href = '/';
        }
        
        // Enregistrement du Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker enregistré avec succès:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Échec de l\'enregistrement du ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>
