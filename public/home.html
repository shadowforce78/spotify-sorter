<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Spotify Playlist Sorter</title>
        <link rel="stylesheet" href="styles.css">

        <!-- Icon -->
        <link rel="icon" type="icon/png" href="icons/shortcut-icon.ico">

        <!-- PWA Metadata -->
        <link rel="manifest" href="manifest.json">
        <meta name="theme-color" content="#1DB954">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style"
            content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Spotify Sorter">
        <link rel="apple-touch-icon" href="icons/icon-192x192.png">
        <link rel="icon" type="image/png" sizes="192x192"
            href="icons/icon-192x192.png">
        <link rel="icon" type="image/png" sizes="512x512"
            href="icons/icon-512x512.png">
        <style>
        .home-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 0 20px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
        }

        .title {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #1DB954;
        }

        .description {
            max-width: 600px;
            margin-bottom: 40px;
            color: #b3b3b3;
            font-size: 1.2rem;
            line-height: 1.6;
        }

        .login-button {
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
        }

        .login-button:hover {
            background-color: #1ed760;
            transform: scale(1.05);
        }
        
        /* Style for the install button */
        .install-button {
            background-color: transparent;
            border: 2px solid #1DB954;
            color: #1DB954;
            border-radius: 30px;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: none; /* Hidden by default */
        }

        .install-button:hover {
            background-color: rgba(29, 185, 84, 0.1);
            transform: scale(1.05);
        }
        
        /* Style for iOS install instructions */
        .ios-install-banner {
            background-color: rgba(29, 185, 84, 0.1);
            border: 1px solid #1DB954;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: none; /* Hidden by default */
            max-width: 600px;
            text-align: left;
        }
        
        .ios-install-banner h3 {
            color: #1DB954;
            margin-top: 0;
            margin-bottom: 8px;
        }
        
        .ios-install-banner ol {
            padding-left: 20px;
            margin: 10px 0;
            color: #b3b3b3;
        }
        
        .ios-install-banner ol li {
            margin-bottom: 5px;
        }
        
        .ios-install-icon {
            vertical-align: middle;
            margin-right: 5px;
            width: 18px;
            height: 18px;
        }
    </style>
    </head>
    <body>
        <div class="home-container">
            <svg class="logo" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"
                    fill="#1DB954" />
            </svg>
            <h1 class="title">Spotify Sorter</h1>
            <p class="description">
                Bienvenue sur l'outil de tri de playlists Spotify.
                Cette application vous permet de facilement trier les morceaux
                de vos playlists.
            </p>
            <a href="/login" class="login-button">Se connecter avec Spotify</a>
            
            <!-- Add the install button (for non-iOS) -->
            <button id="installButton" class="install-button">Installer l'application</button>
            
            <!-- Add iOS installation instructions -->
            <div id="iosInstallBanner" class="ios-install-banner">
                <h3>Installer sur votre appareil iOS</h3>
                <p>Pour installer cette application sur votre écran d'accueil :</p>
                <ol>
                    <li>Appuyez sur <svg class="ios-install-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#1DB954"><path d="M12 16a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2c0-1.1.9-2 2-2zm10-9h-4V5a2 2 0 0 0-2-2H8c-1.11 0-2 .89-2 2v2H2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h20a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM8 5h8v2H8V5zm12 16H4V9h16v12z"/></svg> (Partager)</li>
                    <li>Faites défiler et appuyez sur <strong>"Sur l'écran d'accueil"</strong></li>
                    <li>Appuyez sur <strong>"Ajouter"</strong> en haut à droite</li>
                </ol>
                <p>L'application sera alors disponible sur votre écran d'accueil comme une application native!</p>
            </div>
        </div>

        <script>
        // Vérifier si l'utilisateur est déjà connecté
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si un token existe dans le localStorage et s'il est valide
            const accessToken = localStorage.getItem('spotify_access_token');
            const expirationTime = localStorage.getItem('spotify_token_expiration');
            
            if (accessToken && expirationTime) {
                // Vérifier si le token n'a pas expiré
                if (Date.now() < parseInt(expirationTime)) {
                    // Rediriger vers la page de profil
                    window.location.href = '/profile';
                } else {
                    // Token expiré, nettoyer le localStorage
                    localStorage.removeItem('spotify_access_token');
                    localStorage.removeItem('spotify_refresh_token');
                    localStorage.removeItem('spotify_token_expiration');
                    localStorage.removeItem('spotify_user_profile');
                }
            }
        });

        // Enregistrement du Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker enregistré avec succès:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Échec de l\'enregistrement du ServiceWorker:', error);
                    });
            });
        }
        
        // Détection iOS
        function isIOS() {
            return [
                'iPad Simulator',
                'iPhone Simulator',
                'iPod Simulator',
                'iPad',
                'iPhone',
                'iPod'
            ].includes(navigator.platform)
            // iPad on iOS 13 detection
            || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        }
        
        // Afficher les instructions pour iOS ou le bouton d'installation pour les autres
        if (isIOS()) {
            document.getElementById('iosInstallBanner').style.display = 'block';
        } else {
            // PWA Installation pour les autres navigateurs
            let deferredPrompt;
            const installButton = document.getElementById('installButton');
            
            // Capture the beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the default prompt from showing
                e.preventDefault();
                // Save the event to use it later
                deferredPrompt = e;
                // Show the install button
                installButton.style.display = 'block';
            });
            
            // Add click event to the install button
            installButton.addEventListener('click', async () => {
                // If there's no deferred prompt, return
                if (!deferredPrompt) return;
                
                // Show the installation prompt
                deferredPrompt.prompt();
                
                // Wait for the user's choice
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                
                // Clear the deferred prompt
                deferredPrompt = null;
                
                // Hide the install button
                installButton.style.display = 'none';
            });
            
            // Hide the button if the app is already installed
            window.addEventListener('appinstalled', () => {
                console.log('Application installée avec succès!');
                installButton.style.display = 'none';
                deferredPrompt = null;
            });
        }
    </script>
    </body>
</html>
